// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  picture   String?
  googleId  String?  @unique
  
  // Profile status
  profileCompleted Boolean @default(false)
  
  // Admin flag
  isAdmin   Boolean @default(false)
  
  // Subscription fields
  subscriptionStatus   String   @default("free") // free, active, cancelled, expired
  subscriptionPlan     String?  // monthly, annual
  subscriptionStart    DateTime?
  subscriptionEnd      DateTime?
  freeLogs             Int      @default(15) // Free logs remaining
  
  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  foodEntries       FoodEntry[]
  exerciseEntries   ExerciseEntry[]
  onboardingHistory UserOnboarding[]
  openaiLogs        OpenAILog[]
  subscriptions     Subscription[]
  payments          Payment[]
  
  @@index([email])
  @@index([googleId])
  @@index([isAdmin])
  @@index([subscriptionStatus])
}

model UserOnboarding {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Onboarding data snapshot
  gender           String?
  age              Int?
  height           Float?  // in cm
  goal             String? // weight_loss, improved_health, weight_gain
  currentWeight    Float?
  targetWeight     Float?
  targetDate       DateTime?
  activityLevel    String?
  activityMultiplier Float?
  
  // Diet and Health preferences
  dietPreference          String? // ai_recommended, balanced, mediterranean, keto, etc.
  healthConditions        String[] @default([]) // Array of condition IDs
  customHealthConditions  String[] @default([]) // Array of custom condition strings
  
  // Women-specific health data
  pregnancyStatus  String? // none, pregnant, lactating, both
  trimester        String? // first, second, third
  menstrualCycle   String? // regular, heavy, irregular, none
  
  // Lifestyle factors
  smokingStatus       String? // never, former, current
  cigarettesPerDay    Int?
  alcoholFrequency    String? // never, rarely, moderate, regular, daily
  drinksPerOccasion   Int?
  caffeineIntake      String? // none, low, moderate, high
  
  // Environmental factors
  sunExposure      String? // minimal, moderate, adequate, high
  climate          String? // hot_humid, hot_dry, moderate, cold, very_cold
  skinTone         String? // very_fair, fair, medium, olive, brown, dark_brown, very_dark
  
  // Health metrics
  sleepHours       Float?
  stressLevel      String? // low, moderate, high, severe
  waterIntake      Float?  // liters per day
  
  // Medical information
  medications            String[] @default([]) // Array of medication types
  previousDeficiencies   String[] @default([]) // Array of known deficiencies
  
  // Exercise details
  exerciseTypes     String[] @default([])
  exerciseIntensity String? // light, moderate, vigorous, very_vigorous
  
  // Calculated values at the time
  bmr                    Int?
  tdee                   Int?
  dailyCalorieTarget     Int?
  targetWeightChangeRate Float?
  proteinTarget          Int?
  carbsTarget            Int?
  fatsTarget             Int?
  
  // Micronutrient targets
  vitaminATarget    Float?
  vitaminCTarget    Float?
  vitaminDTarget    Float?
  vitaminETarget    Float?
  vitaminKTarget    Float?
  vitaminB1Target   Float?
  vitaminB2Target   Float?
  vitaminB3Target   Float?
  vitaminB5Target   Float?
  vitaminB6Target   Float?
  vitaminB9Target   Float?
  vitaminB12Target  Float?
  calciumTarget     Float?
  ironTarget        Float?
  magnesiumTarget   Float?
  phosphorusTarget  Float?
  potassiumTarget   Float?
  sodiumTarget      Float?
  zincTarget        Float?
  seleniumTarget    Float?
  copperTarget      Float?
  manganeseTarget   Float?
  
  // Metadata
  completedAt DateTime @default(now())
  createdAt   DateTime @default(now())
  
  @@index([userId])
  @@index([completedAt])
}

model FoodEntry {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Entry details
  date        DateTime @default(now())
  mealType    String   // breakfast, lunch, dinner, snacks
  foodName    String
  description String?
  
  // Nutrition data
  calories    Float
  protein     Float
  carbs       Float
  fats        Float
  
  // Optional detailed nutrients
  cholesterol Float?
  omega3      Float?
  fiber       Float?
  water       Float?
  sodium      Float?
  sugar       Float?
  transFat    Float?
  caffeine    Float?
  alcohol     Float?
  
  // Vitamins
  vitaminA    Float?
  vitaminC    Float?
  vitaminD    Float?
  vitaminE    Float?
  vitaminK    Float?
  vitaminB1   Float? // Thiamine
  vitaminB2   Float? // Riboflavin
  vitaminB3   Float? // Niacin
  vitaminB5   Float? // Pantothenic acid
  vitaminB6   Float? // Pyridoxine
  vitaminB9   Float? // Folate
  vitaminB12  Float? // Cobalamin
  
  // Minerals
  calcium     Float?
  iron        Float?
  magnesium   Float?
  phosphorus  Float?
  potassium   Float?
  zinc        Float?
  manganese   Float?
  copper      Float?
  selenium    Float?
  
  // Metadata
  source      String?  // text, voice, image, barcode, label
  aiParsed    Boolean  @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([userId])
  @@index([date])
  @@index([userId, date])
}

model ExerciseEntry {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Entry details
  date        DateTime @default(now())
  exerciseName String
  description String?
  duration    Float?   // Duration in minutes
  
  // Exercise characteristics
  exerciseType String?  // cardio, strength, flexibility, sports, etc.
  intensity   String?   // light, moderate, vigorous, very_vigorous
  
  // Calories burned (calculated by AI)
  caloriesBurned Float
  
  // Metadata
  aiParsed    Boolean  @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([userId])
  @@index([date])
  @@index([userId, date])
}

model Session {
  id        String   @id
  sid       String   @unique
  data      String
  expiresAt DateTime
  
  @@index([expiresAt])
}

model OpenAILog {
  id        String   @id @default(cuid())
  userId    String?
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  // Request details
  model             String   // gpt-5, gpt-4o, gpt-4-turbo, etc.
  requestType       String   // text, voice, image, embedding
  input             String   @db.Text // User input or prompt
  rawOutput         String?  @db.Text // Raw response from OpenAI
  
  // Token usage
  inputTokens       Int?     // Prompt tokens
  outputTokens      Int?     // Completion tokens
  totalTokens       Int?     // Total tokens used
  
  // Cost tracking (in USD)
  inputCost         Float?   // Cost for input tokens
  outputCost        Float?   // Cost for output tokens
  totalCost         Float?   // Total cost for this request
  
  // Performance metrics
  responseTimeMs    Int?     // Time taken to get response in milliseconds
  
  // Additional metadata
  status            String   @default("success") // success, error, timeout
  errorMessage      String?  @db.Text
  endpoint          String?  // /api/food/parse, /api/chat, etc.
  reasoningEffort   String?  // minimal, medium, high (for reasoning models)
  
  // Timestamps
  createdAt         DateTime @default(now())
  
  @@index([userId])
  @@index([createdAt])
  @@index([model])
  @@index([requestType])
  @@index([status])
  @@index([userId, createdAt])
}

model Subscription {
  id                    String   @id @default(cuid())
  userId                String
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Dodo Payments references
  dodoSubscriptionId    String?  @unique // Dodo's subscription_id
  dodoCustomerId        String?  // Dodo's customer_id
  dodoProductId         String?  // Dodo's product_id
  
  // Subscription details
  plan                  String   // monthly, annual
  status                String   @default("active") // active, cancelled, expired, paused, on_hold, pending, failed
  amount                Float    // Amount paid
  currency              String   @default("USD")
  
  // Subscription period
  startDate             DateTime @default(now())
  endDate               DateTime
  currentPeriodStart    DateTime
  currentPeriodEnd      DateTime
  
  // Billing
  nextBillingDate       DateTime?
  previousBillingDate   DateTime?
  cancelledAt           DateTime?
  cancelReason          String?
  
  // Payment details from Dodo
  paymentFrequencyCount     Int?
  paymentFrequencyInterval  String? // Day, Week, Month, Year
  subscriptionPeriodCount   Int?
  subscriptionPeriodInterval String? // Day, Week, Month, Year
  trialPeriodDays           Int?     @default(0)
  
  // Additional Dodo metadata
  metadata              Json?    // Store additional Dodo data
  
  // Timestamps
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  @@index([userId])
  @@index([status])
  @@index([endDate])
  @@index([dodoSubscriptionId])
}

model Payment {
  id                  String   @id @default(cuid())
  userId              String
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Dodo Payments references
  dodoPaymentId       String?  @unique // Dodo's payment_id
  dodoCustomerId      String?  // Dodo's customer_id
  dodoSubscriptionId  String?  // Dodo's subscription_id (if subscription payment)
  dodoCheckoutSessionId String? // Dodo's checkout_session_id
  
  // Payment details
  amount              Float    // Amount in smallest currency unit (cents)
  currency            String   @default("USD")
  status              String   // succeeded, failed, cancelled, processing, etc.
  method              String?  // card, bank_transfer, etc.
  
  // Card details (if available)
  cardLastFour        String?
  cardNetwork         String?  // VISA, MASTERCARD, etc.
  cardType            String?  // DEBIT, CREDIT
  cardIssuingCountry  String?
  
  // Order details
  orderType           String   // subscription, one-time
  plan                String?  // monthly, annual (if subscription)
  description         String?
  
  // Payment amounts
  totalAmount         Int?     // Total charged in cents
  taxAmount           Int?     // Tax amount in cents
  settlementAmount    Int?     // Amount credited to merchant
  settlementCurrency  String?
  settlementTax       Int?
  
  // Product information
  productCart         Json?    // One-time products purchased
  
  // Status and errors
  errorCode           String?
  errorMessage        String?
  
  // Refund details
  refundedAmount      Float?
  refundedAt          DateTime?
  refundReason        String?
  
  // Additional Dodo metadata
  metadata            Json?    // Store additional Dodo data
  billingAddress      Json?    // Billing address from Dodo
  
  // Timestamps
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  @@index([userId])
  @@index([status])
  @@index([dodoPaymentId])
  @@index([dodoSubscriptionId])
  @@index([createdAt])
}

model WebhookEvent {
  id              String   @id @default(cuid())
  
  // Webhook identification
  webhookId       String   @unique // From webhook-id header
  eventType       String   // payment.succeeded, subscription.active, etc.
  
  // Dodo business reference
  businessId      String?
  
  // Payload
  payload         Json     // Full webhook payload
  
  // Processing status
  processed       Boolean  @default(false)
  processingError String?  @db.Text
  retryCount      Int      @default(0)
  
  // Timestamps
  webhookTimestamp DateTime // From webhook-timestamp header
  receivedAt       DateTime @default(now())
  processedAt      DateTime?
  
  @@index([webhookId])
  @@index([eventType])
  @@index([processed])
  @@index([receivedAt])
}
