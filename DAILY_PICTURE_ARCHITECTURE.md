# Daily Picture Feature - Architecture Diagram

## System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        CLIENT (React)                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚          DailyLogModal Component                          â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚  â”‚
â”‚  â”‚  â”‚ Weight â”‚ Water  â”‚ Pictureâ”‚ â† Tab Navigation           â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚  â”‚
â”‚  â”‚                        â”‚                                   â”‚  â”‚
â”‚  â”‚                        â–¼                                   â”‚  â”‚
â”‚  â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚  â”‚
â”‚  â”‚         â”‚  PictureUploadTab        â”‚                      â”‚  â”‚
â”‚  â”‚         â”‚  - File selection        â”‚                      â”‚  â”‚
â”‚  â”‚         â”‚  - Preview               â”‚                      â”‚  â”‚
â”‚  â”‚         â”‚  - Progress bar          â”‚                      â”‚  â”‚
â”‚  â”‚         â”‚  - Quota display         â”‚                      â”‚  â”‚
â”‚  â”‚         â”‚  - Delete existing       â”‚                      â”‚  â”‚
â”‚  â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                        â”‚                                          â”‚
â”‚                        â–¼                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚         imageCompression.js (browser-image-compression)    â”‚ â”‚
â”‚  â”‚         - Compress to max 2MB                              â”‚ â”‚
â”‚  â”‚         - Resize to max 1920px                             â”‚ â”‚
â”‚  â”‚         - Quality: 0.8                                     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                        â”‚                                          â”‚
â”‚                        â–¼                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚         pictureService.js                                  â”‚ â”‚
â”‚  â”‚         - uploadPicture(date, file, onProgress)            â”‚ â”‚
â”‚  â”‚         - getPicture(date)                                 â”‚ â”‚
â”‚  â”‚         - deletePicture(date)                              â”‚ â”‚
â”‚  â”‚         - getPictureHistory()                              â”‚ â”‚
â”‚  â”‚         - getPictureQuota()                                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â”‚ HTTP(S)
                          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     SERVER (Express.js)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚              routes/daily-log.js                           â”‚â”‚
â”‚  â”‚  POST   /api/daily-log/picture                            â”‚â”‚
â”‚  â”‚  GET    /api/daily-log/:date/picture                      â”‚â”‚
â”‚  â”‚  DELETE /api/daily-log/picture/:date                      â”‚â”‚
â”‚  â”‚  GET    /api/daily-log/pictures/history                   â”‚â”‚
â”‚  â”‚  GET    /api/daily-log/user/picture-quota                 â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                          â”‚                                       â”‚
â”‚                          â–¼                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚         middleware/imageUpload.js (Multer)                 â”‚â”‚
â”‚  â”‚         - Max 10MB file size                               â”‚â”‚
â”‚  â”‚         - JPEG, PNG, WebP, HEIC only                       â”‚â”‚
â”‚  â”‚         - Memory storage (buffer)                          â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                          â”‚                                       â”‚
â”‚                          â–¼                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚         services/dailyPictureService.js                    â”‚â”‚
â”‚  â”‚                                                             â”‚â”‚
â”‚  â”‚  uploadDailyPicture(userId, date, file)                    â”‚â”‚
â”‚  â”‚    1. Check quota (7 for free, âˆ for Pro)                  â”‚â”‚
â”‚  â”‚    2. Delete existing picture if any                       â”‚â”‚
â”‚  â”‚    3. Process image (convert, optimize, thumbnail)         â”‚â”‚
â”‚  â”‚    4. Upload to R2                                         â”‚â”‚
â”‚  â”‚    5. Save metadata to DB                                  â”‚â”‚
â”‚  â”‚    6. Increment pictureCount                               â”‚â”‚
â”‚  â”‚                                                             â”‚â”‚
â”‚  â”‚  deleteDailyPicture(userId, date)                          â”‚â”‚
â”‚  â”‚    1. Delete from R2                                       â”‚â”‚
â”‚  â”‚    2. Delete from DB                                       â”‚â”‚
â”‚  â”‚    3. Decrement pictureCount                               â”‚â”‚
â”‚  â”‚                                                             â”‚â”‚
â”‚  â”‚  getPictureQuota(userId)                                   â”‚â”‚
â”‚  â”‚  getPictureHistory(userId, params)                         â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚             â”‚                          â”‚                        â”‚
â”‚             â–¼                          â–¼                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ imageProcessing.js   â”‚  â”‚   r2StorageService.js        â”‚   â”‚
â”‚  â”‚                      â”‚  â”‚   (AWS SDK S3Client)         â”‚   â”‚
â”‚  â”‚ convertToWebP()      â”‚  â”‚                              â”‚   â”‚
â”‚  â”‚   - Any format â†’     â”‚  â”‚   uploadImage(buffer, key)   â”‚   â”‚
â”‚  â”‚     WebP             â”‚  â”‚   deleteImage(key)           â”‚   â”‚
â”‚  â”‚   - HEIC support     â”‚  â”‚   getImage(key)              â”‚   â”‚
â”‚  â”‚                      â”‚  â”‚                              â”‚   â”‚
â”‚  â”‚ optimizeImage()      â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”‚   - If >500KB,       â”‚                 â”‚                   â”‚
â”‚  â”‚     reduce to 85%    â”‚                 â”‚ S3 Protocol       â”‚
â”‚  â”‚                      â”‚                 â”‚                   â”‚
â”‚  â”‚ generateThumbnail()  â”‚                 â–¼                   â”‚
â”‚  â”‚   - 300x300 square   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   - Smart crop       â”‚  â”‚   Cloudflare R2 Storage     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   - S3-compatible           â”‚   â”‚
â”‚                             â”‚   - $0 egress               â”‚   â”‚
â”‚                             â”‚   - 10GB free tier          â”‚   â”‚
â”‚                             â”‚   - WebP files              â”‚   â”‚
â”‚                             â”‚   - Public URLs             â”‚   â”‚
â”‚                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                â”‚
â”‚                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚                          â”‚    PostgreSQL (Prisma)           â”‚ â”‚
â”‚                          â”‚                                  â”‚ â”‚
â”‚                          â”‚  DailyPicture:                   â”‚ â”‚
â”‚                          â”‚    - id, userId, date            â”‚ â”‚
â”‚                          â”‚    - originalUrl, thumbnailUrl   â”‚ â”‚
â”‚                          â”‚    - fileSize, width, height     â”‚ â”‚
â”‚                          â”‚    - metadata, uploadedAt        â”‚ â”‚
â”‚                          â”‚    @@unique([userId, date])      â”‚ â”‚
â”‚                          â”‚                                  â”‚ â”‚
â”‚                          â”‚  User:                           â”‚ â”‚
â”‚                          â”‚    - pictureCount (quota)        â”‚ â”‚
â”‚                          â”‚    - subscriptionStatus          â”‚ â”‚
â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Data Flow: Upload Picture

```
1. User selects image
   â†“
2. Client compresses image (max 2MB, 1920px)
   â†“
3. Upload to server with progress tracking
   â†“
4. Multer receives file buffer
   â†“
5. dailyPictureService.uploadDailyPicture()
   â”œâ”€â”€ Check quota (7 for free, âˆ for Pro)
   â”œâ”€â”€ Delete existing picture if same date
   â”œâ”€â”€ Convert to WebP
   â”œâ”€â”€ Optimize if >500KB (quality 85%)
   â”œâ”€â”€ Generate 300x300 thumbnail
   â”œâ”€â”€ Upload original to R2: /pictures/{userId}/{date}/original.webp
   â”œâ”€â”€ Upload thumbnail to R2: /pictures/{userId}/{date}/thumbnail.webp
   â”œâ”€â”€ Save metadata to PostgreSQL
   â””â”€â”€ Increment user.pictureCount
   â†“
6. Return URLs to client
   â†“
7. Client displays uploaded picture
```

## Data Flow: Delete Picture

```
1. User clicks delete button
   â†“
2. Client calls pictureService.deletePicture(date)
   â†“
3. Server receives DELETE request
   â†“
4. dailyPictureService.deleteDailyPicture()
   â”œâ”€â”€ Delete from R2 (original + thumbnail)
   â”œâ”€â”€ Delete from PostgreSQL
   â””â”€â”€ Decrement user.pictureCount
   â†“
5. Return success to client
   â†“
6. Client updates UI (removes picture, updates quota)
```

## File Structure

```
server/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ r2StorageService.js        â† Cloudflare R2 integration
â”‚   â”‚   â”œâ”€â”€ imageProcessingService.js  â† WebP conversion, optimization
â”‚   â”‚   â””â”€â”€ dailyPictureService.js     â† Business logic, quota
â”‚   â”œâ”€â”€ middleware/
â”‚   â”‚   â””â”€â”€ imageUpload.js             â† Multer configuration
â”‚   â””â”€â”€ routes/
â”‚       â””â”€â”€ daily-log.js               â† Picture API endpoints
â””â”€â”€ prisma/
    â””â”€â”€ schema.prisma                  â† DailyPicture model

client/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ DailyLogModal.jsx          â† 3-tab modal (Weight|Water|Picture)
â”‚   â”‚   â””â”€â”€ PictureUploadTab.jsx       â† Upload UI component
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â””â”€â”€ pictureService.js          â† API client
â”‚   â””â”€â”€ utils/
â”‚       â””â”€â”€ imageCompression.js        â† Client-side compression
```

## Image Processing Pipeline

```
Input Image (JPEG/PNG/HEIC)
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client Compression  â”‚
â”‚ (browser-image-     â”‚
â”‚  compression)       â”‚
â”‚                     â”‚
â”‚ Max: 2MB            â”‚
â”‚ Max: 1920px         â”‚
â”‚ Quality: 0.8        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Upload to Server    â”‚
â”‚ (multipart/form)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Convert to WebP     â”‚
â”‚ (Sharp library)     â”‚
â”‚                     â”‚
â”‚ - JPEG â†’ WebP       â”‚
â”‚ - PNG â†’ WebP        â”‚
â”‚ - HEIC â†’ WebP       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Optimize if >500KB  â”‚
â”‚                     â”‚
â”‚ Quality: 85%        â”‚
â”‚ Target: 200-800KB   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚               â”‚
           â–¼               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Original   â”‚   â”‚  Thumbnail   â”‚
â”‚   Full Size  â”‚   â”‚   300x300    â”‚
â”‚   WebP       â”‚   â”‚   Square     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                   â”‚
       â”‚                   â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Upload to R2          â”‚
â”‚                         â”‚
â”‚ /pictures/{userId}/     â”‚
â”‚   {date}/               â”‚
â”‚     â”œâ”€ original.webp    â”‚
â”‚     â””â”€ thumbnail.webp   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Quota System

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Free User                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ subscriptionStatus: null/'free'    â”‚
â”‚ Limit: 7 pictures total            â”‚
â”‚                                    â”‚
â”‚ Check before upload:               â”‚
â”‚   if (pictureCount >= 7)           â”‚
â”‚     throw QuotaExceededError       â”‚
â”‚                                    â”‚
â”‚ After upload:                      â”‚
â”‚   pictureCount++                   â”‚
â”‚                                    â”‚
â”‚ After delete:                      â”‚
â”‚   pictureCount--                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Pro User                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ subscriptionStatus: 'active'       â”‚
â”‚ Limit: âˆ (unlimited)               â”‚
â”‚                                    â”‚
â”‚ Check before upload:               â”‚
â”‚   âœ“ Always allowed                 â”‚
â”‚                                    â”‚
â”‚ After upload:                      â”‚
â”‚   pictureCount++                   â”‚
â”‚                                    â”‚
â”‚ After delete:                      â”‚
â”‚   pictureCount--                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Storage Layout (Cloudflare R2)

```
calorie-tracker-pictures/          â† Bucket
â”œâ”€â”€ pictures/
â”‚   â”œâ”€â”€ user-abc123/               â† User ID
â”‚   â”‚   â”œâ”€â”€ 2025-01-15/            â† Date
â”‚   â”‚   â”‚   â”œâ”€â”€ original.webp      â† Full size
â”‚   â”‚   â”‚   â””â”€â”€ thumbnail.webp     â† 300x300
â”‚   â”‚   â”œâ”€â”€ 2025-01-16/
â”‚   â”‚   â”‚   â”œâ”€â”€ original.webp
â”‚   â”‚   â”‚   â””â”€â”€ thumbnail.webp
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ user-def456/
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ ...
```

## Database Schema Relationships

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       User           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)              â”‚
â”‚ email                â”‚
â”‚ subscriptionStatus   â”‚â”€â”€â”€â”€â”
â”‚ pictureCount         â”‚    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
           â”‚                â”‚
           â”‚ 1              â”‚ Quota Check
           â”‚                â”‚
           â”‚ *              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   DailyPicture       â”‚â—„â”€â”€â”€â”˜
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)              â”‚
â”‚ userId (FK)          â”‚
â”‚ date                 â”‚
â”‚ originalUrl          â”‚â”€â”€â”€â”€â”
â”‚ thumbnailUrl         â”‚    â”‚
â”‚ uploadedAt           â”‚    â”‚
â”‚ fileSize             â”‚    â”‚
â”‚ width, height        â”‚    â”‚
â”‚ metadata             â”‚    â”‚
â”‚ dailyLogId (FK)      â”‚    â”‚ R2 URLs
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
           â”‚                â”‚
           â”‚ *              â–¼
           â”‚ 1       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â” â”‚  Cloudflare R2  â”‚
â”‚   DailyLog       â”‚ â”‚                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ original.webp   â”‚
â”‚ id (PK)          â”‚ â”‚ thumbnail.webp  â”‚
â”‚ userId (FK)      â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ date             â”‚
â”‚ weight           â”‚
â”‚ waterIntake      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Constraints:
- DailyPicture: @@unique([userId, date])
- One picture per user per date
- Cascade delete: User â†’ DailyPicture
```

## API Endpoints

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Picture API Routes                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  POST /api/daily-log/picture                               â”‚
â”‚    Body: { date: "2025-01-15" }                            â”‚
â”‚    File: picture (multipart/form-data)                     â”‚
â”‚    Response: { originalUrl, thumbnailUrl, ... }            â”‚
â”‚                                                             â”‚
â”‚  GET /api/daily-log/:date/picture                          â”‚
â”‚    Params: date (YYYY-MM-DD)                               â”‚
â”‚    Response: { originalUrl, thumbnailUrl, ... }            â”‚
â”‚                                                             â”‚
â”‚  DELETE /api/daily-log/picture/:date                       â”‚
â”‚    Params: date (YYYY-MM-DD)                               â”‚
â”‚    Response: { message: "Picture deleted" }                â”‚
â”‚                                                             â”‚
â”‚  GET /api/daily-log/pictures/history                       â”‚
â”‚    Query: startDate, endDate, limit, offset                â”‚
â”‚    Response: [{ date, originalUrl, ... }, ...]             â”‚
â”‚                                                             â”‚
â”‚  GET /api/daily-log/user/picture-quota                     â”‚
â”‚    Response: { isPro, used, limit, remaining }             â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Technology Stack

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Frontend                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ React                     - UI framework               â”‚
â”‚ Vite                      - Build tool                 â”‚
â”‚ Tailwind CSS              - Styling                    â”‚
â”‚ Framer Motion             - Animations                 â”‚
â”‚ Lucide React              - Icons                      â”‚
â”‚ browser-image-compression - Client compression         â”‚
â”‚ react-easy-crop           - Image cropping (future)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Backend                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Node.js + Express         - Server                     â”‚
â”‚ Prisma                    - ORM                        â”‚
â”‚ PostgreSQL                - Database                   â”‚
â”‚ Multer                    - File upload                â”‚
â”‚ Sharp                     - Image processing           â”‚
â”‚ @aws-sdk/client-s3        - R2 integration             â”‚
â”‚ JWT                       - Authentication             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Storage                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Cloudflare R2             - Object storage             â”‚
â”‚   - S3-compatible API                                  â”‚
â”‚   - $0 egress fees                                     â”‚
â”‚   - 10GB free tier                                     â”‚
â”‚   - Public URL support                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**Architecture Principles:**

- ğŸ”’ **Secure**: JWT authentication on all endpoints
- âš¡ **Fast**: Client-side compression reduces upload time
- ğŸ’° **Cost-effective**: Cloudflare R2 free tier for small apps
- ğŸ“± **Mobile-first**: Responsive UI with camera support
- ğŸ¨ **Quality**: WebP format, smart optimization
- ğŸ“Š **Quota-aware**: Fair usage limits for free users
- ğŸ”„ **Atomic**: No race conditions in quota tracking
- ğŸ—‘ï¸ **Clean**: Cascade deletes, orphan prevention
